#!/usr/bin/env node
/**
 * Dotfiles updater.
 *
 * @note PLEASE DO NOT EDIT THIS FILE!
 * This entire file will be updated automatically.
 * - Instead of editing here, please review <https://github.com/clevercanyon/skeleton>.
 */
/* eslint-env es2021, node */

import os        from 'os';
import desm      from 'desm';
import path      from 'path';
import fs        from 'fs-extra';
import crypto    from 'crypto';
import degit     from 'degit';
import { spawn } from 'child_process';

( async () => {
	/**
	 * Initializes vars.
	 */
	const __dirname = desm( import.meta.url );
	const projDir   = path.resolve( __dirname, '../../..' );

	const tmpDir            = await fs.mkdtemp(
		path.resolve( os.tmpdir(), './' + crypto.randomUUID() ),
	);
	const tmpDirUpdaterFile = path.resolve( tmpDir, './dev/.files/bin/updater.js' );

	/**
	 * Downloads latest skeleton.
	 */
	await degit( 'clevercanyon/skeleton' ).clone( tmpDir );

	/**
	 * Runs `npm ci` in latest skeleton directory.
	 */
	await spawn( 'npm', [ 'ci' ], { cwd : tmpDir } );

	/**
	 * Runs updater using files from latest skeleton.
	 */
	( await import( tmpDirUpdaterFile ) ).default( { projDir } );

	/**
	 * Removes tmp directory.
	 */
	await fs.remove( tmpDir ); // Housekeeping.
} )();
